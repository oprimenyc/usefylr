{% extends "base_layout.html" %}

{% block title %}.fylr | Command Center{% endblock %}

{% block content %}
<div class="command-center">
    <div class="dashboard-3col">
        <!-- Column 1: Vitals -->
        <div class="col-vitals">
            <div class="vitals-card">
                <div class="vitals-label">Estimated Tax Liability</div>
                <div class="vitals-value liability" id="taxLiability">$0</div>
            </div>
            
            <div class="vitals-card">
                <div class="vitals-label">Total Savings Found</div>
                <div class="vitals-value savings" id="totalSavings">$0</div>
            </div>
            
            <div class="vitals-card">
                <div class="vitals-label">Audit Risk Level</div>
                <div class="vitals-value" id="auditRiskPercent">0%</div>
                <div class="audit-risk-bar">
                    <div class="audit-risk-fill" id="auditRiskFill" style="width: 0%;"></div>
                </div>
                <div class="audit-risk-label">
                    <span>Low</span>
                    <span>High</span>
                </div>
            </div>
        </div>
        
        <!-- Column 2: Activity -->
        <div class="col-activity">
            <div class="activity-card">
                <div class="activity-header">
                    <div class="activity-title">Resume Session</div>
                    <div class="activity-subtitle">Recent activity</div>
                </div>
                
                <div class="activity-feed" id="activityFeed">
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-name">Schedule C Started</div>
                            <div class="activity-meta">2 hours ago</div>
                        </div>
                        <div class="activity-amount">60%</div>
                    </div>
                    
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-name">Mileage Tracked</div>
                            <div class="activity-meta">Yesterday</div>
                        </div>
                        <div class="activity-amount">$1,247</div>
                    </div>
                    
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-name">Office Supplies</div>
                            <div class="activity-meta">3 days ago</div>
                        </div>
                        <div class="activity-amount">$89</div>
                    </div>
                    
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-laptop"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-name">Software Subscription</div>
                            <div class="activity-meta">5 days ago</div>
                        </div>
                        <div class="activity-amount">$49</div>
                    </div>
                    
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-phone"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-name">Phone Bill (50%)</div>
                            <div class="activity-meta">1 week ago</div>
                        </div>
                        <div class="activity-amount">$45</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Column 3: Insights -->
        <div class="col-insights">
            <div class="insights-card">
                <div class="insights-header">
                    <i class="fas fa-lightbulb"></i>
                    <div class="insights-title">AI Tax Tips</div>
                </div>
                
                <div class="insight-tip">
                    <div class="insight-tip-text">Based on your mileage deductions, you may qualify for the standard mileage rate of $0.67/mile for 2024.</div>
                    <div class="insight-tip-meta">IRS Publication 463</div>
                </div>
                
                <div class="insight-tip">
                    <div class="insight-tip-text">Your home office deduction could be calculated using the simplified method ($5/sq ft, up to 300 sq ft).</div>
                    <div class="insight-tip-meta">Form 8829</div>
                </div>
                
                <div class="insight-tip">
                    <div class="insight-tip-text">Consider quarterly estimated payments to avoid underpayment penalties.</div>
                    <div class="insight-tip-meta">Form 1040-ES</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load saved data from localStorage
    const streams = JSON.parse(localStorage.getItem('fylr_revenue_streams') || '[]');
    const transactions = JSON.parse(localStorage.getItem('fylr_transactions') || '[]');
    
    // Calculate totals
    let totalRevenue = streams.reduce((sum, s) => sum + (parseFloat(s.ytdEarnings) || 0), 0);
    let totalDeductions = transactions.reduce((sum, t) => {
        if (t.type === 'expense' && t.deductible_percentage) {
            return sum + (parseFloat(t.amount) * (t.deductible_percentage / 100));
        }
        return sum;
    }, 0);
    
    // Estimate tax liability (32% self-employment rate)
    const taxableIncome = Math.max(0, totalRevenue - totalDeductions);
    const estimatedTax = taxableIncome * 0.32;
    
    // Update vitals
    document.getElementById('taxLiability').textContent = '$' + estimatedTax.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
    document.getElementById('totalSavings').textContent = '$' + (totalDeductions * 0.32).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
    
    // Calculate audit risk (simplified)
    let auditRisk = 5; // Base risk
    if (totalDeductions > totalRevenue * 0.5) auditRisk += 20;
    if (transactions.some(t => t.audit_risk === 'high')) auditRisk += 15;
    auditRisk = Math.min(100, auditRisk);
    
    document.getElementById('auditRiskPercent').textContent = auditRisk + '%';
    document.getElementById('auditRiskFill').style.width = auditRisk + '%';
    
    // Update activity feed with recent transactions
    if (transactions.length > 0) {
        const feed = document.getElementById('activityFeed');
        feed.innerHTML = '';
        
        const recentTxns = transactions.slice(-5).reverse();
        recentTxns.forEach(txn => {
            const icon = txn.type === 'income' ? 'fa-arrow-down' : 'fa-arrow-up';
            const iconColor = txn.type === 'income' ? '#00D084' : '#FF6B00';
            
            feed.innerHTML += `
                <div class="activity-item">
                    <div class="activity-icon" style="color: ${iconColor}; background: ${iconColor}10;">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-name">${txn.description || txn.category || 'Transaction'}</div>
                        <div class="activity-meta">${txn.category || ''}</div>
                    </div>
                    <div class="activity-amount" style="color: ${txn.type === 'income' ? '#00D084' : '#FFFFFF'}">
                        ${txn.type === 'income' ? '+' : '-'}$${parseFloat(txn.amount).toLocaleString()}
                    </div>
                </div>
            `;
        });
    }
});
</script>
{% endblock %}
