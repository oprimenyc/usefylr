{% extends "base_layout.html" %}

{% block title %}Revenue Streams - .fylr{% endblock %}

{% block content %}
<div class="container-fluid py-5" style="padding-top: 100px !important;">
    <div class="container">
        <!-- Header Section -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="text-primary mb-2">Revenue Streams</h1>
                <p class="text-muted">Track all your 1099 income sources in one place</p>
            </div>
            <button class="btn btn-orange btn-lg" onclick="openAddStreamModal()">
                <i class="fas fa-plus me-2"></i>Add Stream
            </button>
        </div>

        <!-- Summary Cards Row -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="premium-card text-center">
                    <div class="stat-value text-primary" id="totalRevenue">$0</div>
                    <div class="stat-label text-muted">Total Revenue YTD</div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="premium-card text-center">
                    <div class="stat-value text-orange" id="totalTaxOwed">$0</div>
                    <div class="stat-label text-muted">Estimated Tax Owed</div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="premium-card text-center">
                    <div class="stat-value text-success" id="totalDeductions">$0</div>
                    <div class="stat-label text-muted">Total Deductions</div>
                </div>
            </div>
        </div>

        <!-- Revenue Stream Tiles -->
        <div class="row" id="streamTilesContainer">
            <!-- Stream tiles will be dynamically inserted here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-5" style="display: none;">
            <div class="premium-card" style="max-width: 500px; margin: 0 auto;">
                <i class="fas fa-layer-group text-orange mb-3" style="font-size: 3rem;"></i>
                <h4 class="text-primary mb-3">No Revenue Streams Yet</h4>
                <p class="text-muted mb-4">Add your first income source to start tracking your 1099 revenue and tax obligations.</p>
                <button class="btn btn-orange" onclick="openAddStreamModal()">
                    <i class="fas fa-plus me-2"></i>Add Your First Stream
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Stream Modal -->
<div class="modal fade" id="addStreamModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content premium-card" style="border: 1px solid var(--border-color);">
            <div class="modal-header border-0">
                <h5 class="modal-title text-primary">
                    <i class="fas fa-plus-circle text-orange me-2"></i>Add Revenue Stream
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Quick Select Icons -->
                <div class="mb-4">
                    <label class="form-label text-muted mb-3">Select Platform</label>
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-glass platform-btn" data-platform="uber" data-icon="fas fa-car">
                            <i class="fas fa-car me-2"></i>Uber
                        </button>
                        <button type="button" class="btn btn-glass platform-btn" data-platform="lyft" data-icon="fas fa-taxi">
                            <i class="fas fa-taxi me-2"></i>Lyft
                        </button>
                        <button type="button" class="btn btn-glass platform-btn" data-platform="doordash" data-icon="fas fa-utensils">
                            <i class="fas fa-utensils me-2"></i>DoorDash
                        </button>
                        <button type="button" class="btn btn-glass platform-btn" data-platform="instacart" data-icon="fas fa-shopping-cart">
                            <i class="fas fa-shopping-cart me-2"></i>Instacart
                        </button>
                        <button type="button" class="btn btn-glass platform-btn" data-platform="freelance" data-icon="fas fa-laptop-code">
                            <i class="fas fa-laptop-code me-2"></i>Freelance
                        </button>
                        <button type="button" class="btn btn-glass platform-btn" data-platform="consulting" data-icon="fas fa-briefcase">
                            <i class="fas fa-briefcase me-2"></i>Consulting
                        </button>
                        <button type="button" class="btn btn-glass platform-btn" data-platform="etsy" data-icon="fas fa-store">
                            <i class="fas fa-store me-2"></i>Etsy
                        </button>
                        <button type="button" class="btn btn-glass platform-btn" data-platform="custom" data-icon="fas fa-plus">
                            <i class="fas fa-plus me-2"></i>Other
                        </button>
                    </div>
                </div>

                <!-- Custom Name (shown when "Other" is selected) -->
                <div class="mb-3" id="customNameGroup" style="display: none;">
                    <label class="form-label text-muted">Custom Name</label>
                    <input type="text" class="form-control glass-input" id="customStreamName" placeholder="e.g., Photography Business">
                </div>

                <!-- Initial Revenue -->
                <div class="mb-3">
                    <label class="form-label text-muted">YTD Revenue (Optional)</label>
                    <div class="input-group">
                        <span class="input-group-text" style="background: rgba(255,255,255,0.05); border-color: var(--border-color); color: var(--text-muted);">$</span>
                        <input type="number" class="form-control glass-input" id="initialRevenue" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <!-- 1099 Expected -->
                <div class="mb-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="expects1099" checked>
                        <label class="form-check-label text-muted" for="expects1099">
                            I expect to receive a 1099 from this source
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-glass" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-orange" onclick="addStream()">
                    <i class="fas fa-plus me-2"></i>Add Stream
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Action Modal -->
<div class="modal fade" id="quickActionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content premium-card" style="border: 1px solid var(--border-color);">
            <div class="modal-header border-0">
                <h5 class="modal-title text-primary" id="quickActionTitle">
                    <i class="fas fa-bolt text-orange me-2"></i>Quick Action
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="quickActionBody">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-glass" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-orange" id="quickActionSubmit">
                    <i class="fas fa-check me-2"></i>Add Deduction
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.platform-btn {
    transition: all 0.3s ease;
}
.platform-btn.active {
    background: rgba(255, 107, 0, 0.2) !important;
    border-color: var(--fylr-orange) !important;
    color: var(--fylr-orange) !important;
}
.platform-btn:hover {
    border-color: var(--fylr-orange);
    color: var(--fylr-orange);
}
.stream-tile {
    transition: all 0.3s ease;
}
.stream-tile:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 32px rgba(255, 107, 0, 0.15);
}
.quick-chip {
    display: inline-flex;
    align-items: center;
    padding: 6px 12px;
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    color: var(--text-muted);
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-right: 8px;
    margin-bottom: 8px;
}
.quick-chip:hover {
    background: rgba(255, 107, 0, 0.1);
    border-color: var(--fylr-orange);
    color: var(--fylr-orange);
}
.quick-chip i {
    margin-right: 6px;
    font-size: 0.75rem;
}
.tax-owed {
    color: var(--fylr-orange);
}
.tax-refund {
    color: #10B981;
}
.stream-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: rgba(255, 107, 0, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--fylr-orange);
    font-size: 1.25rem;
}
.revenue-amount {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
}
.deduction-total {
    font-size: 0.9rem;
    color: #10B981;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let streams = [];
let selectedPlatform = null;
let selectedIcon = null;
let currentStreamId = null;

const platformIcons = {
    'uber': 'fas fa-car',
    'lyft': 'fas fa-taxi',
    'doordash': 'fas fa-utensils',
    'instacart': 'fas fa-shopping-cart',
    'freelance': 'fas fa-laptop-code',
    'consulting': 'fas fa-briefcase',
    'etsy': 'fas fa-store',
    'custom': 'fas fa-building'
};

const quickActions = {
    'uber': [
        { id: 'mileage', label: 'Add Mileage', icon: 'fas fa-road', type: 'mileage' },
        { id: 'phone', label: 'Phone Bill', icon: 'fas fa-mobile-alt', type: 'phone' },
        { id: 'car_wash', label: 'Car Wash', icon: 'fas fa-spray-can', type: 'expense' }
    ],
    'lyft': [
        { id: 'mileage', label: 'Add Mileage', icon: 'fas fa-road', type: 'mileage' },
        { id: 'phone', label: 'Phone Bill', icon: 'fas fa-mobile-alt', type: 'phone' },
        { id: 'car_maintenance', label: 'Car Repair', icon: 'fas fa-wrench', type: 'expense' }
    ],
    'doordash': [
        { id: 'mileage', label: 'Add Mileage', icon: 'fas fa-road', type: 'mileage' },
        { id: 'phone', label: 'Phone Bill', icon: 'fas fa-mobile-alt', type: 'phone' },
        { id: 'hot_bag', label: 'Hot Bag', icon: 'fas fa-shopping-bag', type: 'expense' }
    ],
    'instacart': [
        { id: 'mileage', label: 'Add Mileage', icon: 'fas fa-road', type: 'mileage' },
        { id: 'phone', label: 'Phone Bill', icon: 'fas fa-mobile-alt', type: 'phone' }
    ],
    'freelance': [
        { id: 'software', label: 'Software', icon: 'fas fa-code', type: 'expense' },
        { id: 'home_office', label: 'Home Office', icon: 'fas fa-home', type: 'home_office' },
        { id: 'equipment', label: 'Equipment', icon: 'fas fa-laptop', type: 'expense' }
    ],
    'consulting': [
        { id: 'travel', label: 'Travel', icon: 'fas fa-plane', type: 'travel' },
        { id: 'meals', label: 'Business Meals', icon: 'fas fa-utensils', type: 'meals' },
        { id: 'home_office', label: 'Home Office', icon: 'fas fa-home', type: 'home_office' }
    ],
    'etsy': [
        { id: 'supplies', label: 'Supplies', icon: 'fas fa-box', type: 'expense' },
        { id: 'shipping', label: 'Shipping', icon: 'fas fa-truck', type: 'expense' },
        { id: 'home_office', label: 'Home Office', icon: 'fas fa-home', type: 'home_office' }
    ],
    'custom': [
        { id: 'expense', label: 'Add Expense', icon: 'fas fa-receipt', type: 'expense' },
        { id: 'home_office', label: 'Home Office', icon: 'fas fa-home', type: 'home_office' }
    ]
};

document.addEventListener('DOMContentLoaded', function() {
    loadStreams();
    
    document.querySelectorAll('.platform-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.platform-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            selectedPlatform = this.dataset.platform;
            selectedIcon = this.dataset.icon;
            
            if (selectedPlatform === 'custom') {
                document.getElementById('customNameGroup').style.display = 'block';
            } else {
                document.getElementById('customNameGroup').style.display = 'none';
            }
        });
    });
});

function loadStreams() {
    const stored = localStorage.getItem('revenueStreams');
    if (stored) {
        streams = JSON.parse(stored);
    } else {
        streams = [
            {
                id: 'demo-1',
                platform: 'uber',
                name: 'Uber',
                icon: 'fas fa-car',
                revenue: 12450.00,
                deductions: 3200.00,
                expects1099: true
            },
            {
                id: 'demo-2',
                platform: 'doordash',
                name: 'DoorDash',
                icon: 'fas fa-utensils',
                revenue: 8320.00,
                deductions: 1850.00,
                expects1099: true
            },
            {
                id: 'demo-3',
                platform: 'freelance',
                name: 'Web Development',
                icon: 'fas fa-laptop-code',
                revenue: 24500.00,
                deductions: 4200.00,
                expects1099: true
            }
        ];
    }
    renderStreams();
}

function saveStreams() {
    localStorage.setItem('revenueStreams', JSON.stringify(streams));
}

function renderStreams() {
    const container = document.getElementById('streamTilesContainer');
    const emptyState = document.getElementById('emptyState');
    
    if (streams.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        updateTotals();
        return;
    }
    
    emptyState.style.display = 'none';
    
    container.innerHTML = streams.map(stream => {
        const taxableIncome = stream.revenue - stream.deductions;
        const estimatedTax = taxableIncome * 0.32; // ~32% combined rate for self-employment
        const taxClass = estimatedTax > 0 ? 'tax-owed' : 'tax-refund';
        const taxLabel = estimatedTax > 0 ? 'Estimated Tax' : 'Potential Refund';
        const actions = quickActions[stream.platform] || quickActions['custom'];
        
        return `
            <div class="col-lg-6 mb-4">
                <div class="premium-card stream-tile">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="d-flex align-items-center">
                            <div class="stream-icon me-3">
                                <i class="${stream.icon}"></i>
                            </div>
                            <div>
                                <h5 class="text-primary mb-1">${stream.name}</h5>
                                <span class="text-muted small">${stream.expects1099 ? '1099 Expected' : 'No 1099'}</span>
                            </div>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-glass btn-sm" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-dark">
                                <li><a class="dropdown-item" href="#" onclick="editStream('${stream.id}')"><i class="fas fa-edit me-2"></i>Edit</a></li>
                                <li><a class="dropdown-item" href="#" onclick="addRevenue('${stream.id}')"><i class="fas fa-plus me-2"></i>Add Revenue</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteStream('${stream.id}')"><i class="fas fa-trash me-2"></i>Delete</a></li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="text-muted small mb-1">Total Revenue</div>
                            <div class="revenue-amount">$${stream.revenue.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                        </div>
                        <div class="col-6 text-end">
                            <div class="text-muted small mb-1">${taxLabel}</div>
                            <div class="revenue-amount ${taxClass}">$${Math.abs(estimatedTax).toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">Deductions Applied</span>
                            <span class="deduction-total">-$${stream.deductions.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar-orange" style="width: ${stream.revenue > 0 ? Math.min((stream.deductions / stream.revenue) * 100, 100) : 0}%;"></div>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <div class="text-muted small mb-2"><i class="fas fa-bolt text-orange me-1"></i>Quick Actions</div>
                        ${actions.map(action => `
                            <span class="quick-chip" onclick="openQuickAction('${stream.id}', '${action.type}', '${action.label}')">
                                <i class="${action.icon}"></i>${action.label}
                            </span>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    updateTotals();
}

function updateTotals() {
    const totalRevenue = streams.reduce((sum, s) => sum + s.revenue, 0);
    const totalDeductions = streams.reduce((sum, s) => sum + s.deductions, 0);
    const taxableIncome = totalRevenue - totalDeductions;
    const totalTax = taxableIncome * 0.32;
    
    document.getElementById('totalRevenue').textContent = '$' + totalRevenue.toLocaleString('en-US', {minimumFractionDigits: 2});
    document.getElementById('totalTaxOwed').textContent = '$' + totalTax.toLocaleString('en-US', {minimumFractionDigits: 2});
    document.getElementById('totalDeductions').textContent = '$' + totalDeductions.toLocaleString('en-US', {minimumFractionDigits: 2});
}

function openAddStreamModal() {
    selectedPlatform = null;
    selectedIcon = null;
    document.querySelectorAll('.platform-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('customNameGroup').style.display = 'none';
    document.getElementById('customStreamName').value = '';
    document.getElementById('initialRevenue').value = '';
    document.getElementById('expects1099').checked = true;
    
    const modal = new bootstrap.Modal(document.getElementById('addStreamModal'));
    modal.show();
}

function addStream() {
    if (!selectedPlatform) {
        alert('Please select a platform');
        return;
    }
    
    let name = selectedPlatform.charAt(0).toUpperCase() + selectedPlatform.slice(1);
    if (selectedPlatform === 'custom') {
        name = document.getElementById('customStreamName').value || 'Custom Income';
    }
    
    const revenue = parseFloat(document.getElementById('initialRevenue').value) || 0;
    const expects1099 = document.getElementById('expects1099').checked;
    
    const newStream = {
        id: 'stream-' + Date.now(),
        platform: selectedPlatform,
        name: name,
        icon: selectedIcon || platformIcons[selectedPlatform],
        revenue: revenue,
        deductions: 0,
        expects1099: expects1099
    };
    
    streams.push(newStream);
    saveStreams();
    renderStreams();
    
    bootstrap.Modal.getInstance(document.getElementById('addStreamModal')).hide();
}

function openQuickAction(streamId, actionType, actionLabel) {
    currentStreamId = streamId;
    const stream = streams.find(s => s.id === streamId);
    
    document.getElementById('quickActionTitle').innerHTML = `
        <i class="fas fa-bolt text-orange me-2"></i>${actionLabel} - ${stream.name}
    `;
    
    let bodyContent = '';
    
    switch(actionType) {
        case 'mileage':
            bodyContent = `
                <div class="mb-3">
                    <label class="form-label text-muted">Miles Driven</label>
                    <input type="number" class="form-control glass-input" id="quickMiles" placeholder="e.g., 150">
                    <small class="text-muted">Current IRS rate: $0.67/mile (2024)</small>
                </div>
                <div class="premium-card" style="background: rgba(255, 107, 0, 0.05);">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Estimated Deduction:</span>
                        <span class="text-orange" id="mileageDeduction">$0.00</span>
                    </div>
                </div>
            `;
            break;
        case 'phone':
            bodyContent = `
                <div class="mb-3">
                    <label class="form-label text-muted">Monthly Phone Bill</label>
                    <div class="input-group">
                        <span class="input-group-text" style="background: rgba(255,255,255,0.05); border-color: var(--border-color); color: var(--text-muted);">$</span>
                        <input type="number" class="form-control glass-input" id="quickPhone" placeholder="e.g., 85">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">Business Use Percentage</label>
                    <input type="range" class="form-range" id="phonePercent" min="0" max="100" value="50">
                    <div class="text-center text-orange" id="phonePercentLabel">50%</div>
                </div>
                <div class="premium-card" style="background: rgba(255, 107, 0, 0.05);">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Deductible Amount:</span>
                        <span class="text-orange" id="phoneDeduction">$0.00</span>
                    </div>
                </div>
            `;
            break;
        case 'home_office':
            bodyContent = `
                <div class="mb-3">
                    <label class="form-label text-muted">Home Square Footage</label>
                    <input type="number" class="form-control glass-input" id="homeSqFt" placeholder="e.g., 1500">
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">Office Square Footage</label>
                    <input type="number" class="form-control glass-input" id="officeSqFt" placeholder="e.g., 150">
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">Annual Home Expenses</label>
                    <div class="input-group">
                        <span class="input-group-text" style="background: rgba(255,255,255,0.05); border-color: var(--border-color); color: var(--text-muted);">$</span>
                        <input type="number" class="form-control glass-input" id="homeExpenses" placeholder="Rent, utilities, insurance">
                    </div>
                </div>
                <div class="premium-card" style="background: rgba(255, 107, 0, 0.05);">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Deductible Amount:</span>
                        <span class="text-orange" id="homeOfficeDeduction">$0.00</span>
                    </div>
                </div>
            `;
            break;
        default:
            bodyContent = `
                <div class="mb-3">
                    <label class="form-label text-muted">Description</label>
                    <input type="text" class="form-control glass-input" id="quickDescription" placeholder="What did you purchase?">
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">Amount</label>
                    <div class="input-group">
                        <span class="input-group-text" style="background: rgba(255,255,255,0.05); border-color: var(--border-color); color: var(--text-muted);">$</span>
                        <input type="number" class="form-control glass-input" id="quickAmount" placeholder="0.00" step="0.01">
                    </div>
                </div>
            `;
    }
    
    document.getElementById('quickActionBody').innerHTML = bodyContent;
    document.getElementById('quickActionSubmit').onclick = () => submitQuickAction(actionType);
    
    const modal = new bootstrap.Modal(document.getElementById('quickActionModal'));
    modal.show();
    
    // Add event listeners for real-time calculations
    setTimeout(() => {
        if (actionType === 'mileage') {
            document.getElementById('quickMiles')?.addEventListener('input', function() {
                const miles = parseFloat(this.value) || 0;
                document.getElementById('mileageDeduction').textContent = '$' + (miles * 0.67).toFixed(2);
            });
        }
        if (actionType === 'phone') {
            const updatePhone = () => {
                const bill = parseFloat(document.getElementById('quickPhone').value) || 0;
                const percent = parseFloat(document.getElementById('phonePercent').value) || 0;
                document.getElementById('phonePercentLabel').textContent = percent + '%';
                document.getElementById('phoneDeduction').textContent = '$' + ((bill * percent / 100) * 12).toFixed(2);
            };
            document.getElementById('quickPhone')?.addEventListener('input', updatePhone);
            document.getElementById('phonePercent')?.addEventListener('input', updatePhone);
        }
        if (actionType === 'home_office') {
            const updateHomeOffice = () => {
                const homeSqFt = parseFloat(document.getElementById('homeSqFt').value) || 1;
                const officeSqFt = parseFloat(document.getElementById('officeSqFt').value) || 0;
                const expenses = parseFloat(document.getElementById('homeExpenses').value) || 0;
                const percent = (officeSqFt / homeSqFt);
                document.getElementById('homeOfficeDeduction').textContent = '$' + (expenses * percent).toFixed(2);
            };
            document.getElementById('homeSqFt')?.addEventListener('input', updateHomeOffice);
            document.getElementById('officeSqFt')?.addEventListener('input', updateHomeOffice);
            document.getElementById('homeExpenses')?.addEventListener('input', updateHomeOffice);
        }
    }, 100);
}

function submitQuickAction(actionType) {
    let deductionAmount = 0;
    
    switch(actionType) {
        case 'mileage':
            const miles = parseFloat(document.getElementById('quickMiles').value) || 0;
            deductionAmount = miles * 0.67;
            break;
        case 'phone':
            const bill = parseFloat(document.getElementById('quickPhone').value) || 0;
            const percent = parseFloat(document.getElementById('phonePercent').value) || 0;
            deductionAmount = (bill * percent / 100) * 12;
            break;
        case 'home_office':
            const homeSqFt = parseFloat(document.getElementById('homeSqFt').value) || 1;
            const officeSqFt = parseFloat(document.getElementById('officeSqFt').value) || 0;
            const expenses = parseFloat(document.getElementById('homeExpenses').value) || 0;
            deductionAmount = expenses * (officeSqFt / homeSqFt);
            break;
        default:
            deductionAmount = parseFloat(document.getElementById('quickAmount').value) || 0;
    }
    
    const streamIndex = streams.findIndex(s => s.id === currentStreamId);
    if (streamIndex >= 0) {
        streams[streamIndex].deductions += deductionAmount;
        saveStreams();
        renderStreams();
    }
    
    bootstrap.Modal.getInstance(document.getElementById('quickActionModal')).hide();
}

function addRevenue(streamId) {
    const amount = prompt('Enter revenue amount:');
    if (amount && !isNaN(parseFloat(amount))) {
        const streamIndex = streams.findIndex(s => s.id === streamId);
        if (streamIndex >= 0) {
            streams[streamIndex].revenue += parseFloat(amount);
            saveStreams();
            renderStreams();
        }
    }
}

function deleteStream(streamId) {
    if (confirm('Are you sure you want to delete this revenue stream?')) {
        streams = streams.filter(s => s.id !== streamId);
        saveStreams();
        renderStreams();
    }
}

function editStream(streamId) {
    alert('Edit functionality coming soon!');
}
</script>
{% endblock %}
