{% extends 'layout.html' %}
{% from 'components/form_renderer.html' import render_summary_view %}

{% block title %}View {{ form.form_type.name }} - Tax Year {{ form.tax_year }}{% endblock %}

{% block extra_head %}
<style>
  .field-label {
    font-weight: 600;
    color: #6c757d;
  }
  
  .field-value {
    font-size: 1.1rem;
  }
  
  .action-panel {
    position: sticky;
    top: 20px;
    z-index: 10;
  }
  
  .action-card {
    border-left: 4px solid var(--fylr-orange);
  }
  
  @media print {
    .no-print {
      display: none !important;
    }
    
    body {
      padding: 0;
      margin: 0;
    }
    
    .container {
      width: 100%;
      max-width: 100%;
      padding: 0;
      margin: 0;
    }
    
    .card {
      border: none !important;
      box-shadow: none !important;
    }
    
    .card-header {
      background-color: #fff !important;
      border-bottom: 1px solid #000 !important;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <!-- Form Content -->
        <div class="col-lg-8">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h1 class="h2 mb-0">{{ form_template.title }}</h1>
                    <p class="lead text-muted">Tax Year {{ form.tax_year }}</p>
                </div>
                <div class="no-print">
                    <a href="{{ url_for('forms.form_list') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i> Back to Forms
                    </a>
                </div>
            </div>
            
            <!-- Form Status -->
            <div class="alert alert-{% if form.status == 'completed' %}success{% else %}warning{% endif %} no-print">
                <div class="d-flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-{% if form.status == 'completed' %}check-circle{% else %}exclamation-triangle{% endif %} fa-2x me-3"></i>
                    </div>
                    <div>
                        <h5 class="alert-heading">Form Status: {{ form.status|title }}</h5>
                        <p class="mb-0">
                            {% if form.status == 'completed' %}
                                This form has been completed and is ready for submission.
                            {% elif form.status == 'draft' %}
                                This form is still in draft and needs to be completed.
                            {% else %}
                                This form is in progress.
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Form Summary -->
            {{ render_summary_view(form_template, form.data) }}
            
            <!-- Disclaimer -->
            <div class="card bg-light mt-4 mb-4 no-print">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-exclamation-circle me-2 text-warning"></i> Important Disclaimer</h5>
                    <p class="card-text small">
                        This document is provided for informational purposes only and should be reviewed by you for accuracy
                        and completeness before filing. .fylr does not provide legal or tax advice. We recommend consulting
                        with a qualified tax professional if you have questions about your specific tax situation.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Action Panel -->
        <div class="col-lg-4 no-print">
            <div class="action-panel">
                <!-- Main Actions -->
                <div class="card shadow-sm mb-4 action-card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Form Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button onclick="window.print()" class="btn btn-primary">
                                <i class="fas fa-print me-2"></i> Print Form
                            </button>
                            
                            {% if form.pdf_path %}
                                <a href="{{ url_for('forms.download_form', form_id=form.id) }}" class="btn btn-success">
                                    <i class="fas fa-download me-2"></i> Download PDF
                                </a>
                            {% else %}
                                <a href="{{ url_for('forms.download_form', form_id=form.id) }}" class="btn btn-success">
                                    <i class="fas fa-file-pdf me-2"></i> Generate PDF
                                </a>
                            {% endif %}
                            
                            <a href="{{ url_for('forms.edit_form', form_type_id=form_template.form_id, id=form.id) }}" class="btn btn-outline-primary">
                                <i class="fas fa-edit me-2"></i> Edit Form
                            </a>
                            
                            {% if current_user.plan.value in ['guided', 'concierge'] %}
                                <a href="{{ url_for('export') }}?form_ids={{ form.id }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-file-export me-2"></i> Export Form
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Form Details -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Form Details</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-start px-0">
                                <div class="ms-2 me-auto">
                                    <div class="fw-bold">Form Type</div>
                                    {{ form.form_type.name }}
                                </div>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-start px-0">
                                <div class="ms-2 me-auto">
                                    <div class="fw-bold">Tax Year</div>
                                    {{ form.tax_year }}
                                </div>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-start px-0">
                                <div class="ms-2 me-auto">
                                    <div class="fw-bold">Created</div>
                                    {{ form.created_at.strftime('%b %d, %Y') }}
                                </div>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-start px-0">
                                <div class="ms-2 me-auto">
                                    <div class="fw-bold">Last Updated</div>
                                    {{ form.updated_at.strftime('%b %d, %Y') }}
                                </div>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-start px-0">
                                <div class="ms-2 me-auto">
                                    <div class="fw-bold">Status</div>
                                    <span class="badge bg-{% if form.status == 'completed' %}success{% else %}warning{% endif %}">
                                        {{ form.status|title }}
                                    </span>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <!-- AI Tax Insights -->
                {% if current_user.plan.value in ['guided', 'concierge'] %}
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fas fa-robot me-2 text-fylr-orange"></i> AI Tax Insights</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">Our AI has analyzed your form entries and can provide insights to help you maximize your tax benefits.</p>
                        
                        <div id="taxInsights">
                            <div class="placeholder-glow mb-3">
                                <span class="placeholder col-12"></span>
                                <span class="placeholder col-10"></span>
                                <span class="placeholder col-8"></span>
                            </div>
                            
                            <button class="btn btn-sm btn-outline-primary w-100" id="loadInsightsBtn">
                                <i class="fas fa-brain me-2"></i> Generate Insights
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Danger Zone -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0 text-danger">Danger Zone</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">Be careful with these actions - they cannot be undone.</p>
                        
                        <button type="button" class="btn btn-outline-danger w-100" data-bs-toggle="modal" data-bs-target="#deleteFormModal">
                            <i class="fas fa-trash-alt me-2"></i> Delete Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Form Modal -->
<div class="modal fade" id="deleteFormModal" tabindex="-1" aria-labelledby="deleteFormModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteFormModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this form? This action cannot be undone.</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    All form data and any generated PDFs will be permanently deleted.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('forms.delete_form', form_id=form.id) }}" method="POST">
                    <button type="submit" class="btn btn-danger">Delete Form</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const loadInsightsBtn = document.getElementById('loadInsightsBtn');
        if (loadInsightsBtn) {
            loadInsightsBtn.addEventListener('click', function() {
                this.disabled = true;
                this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';
                
                const insightsContainer = document.getElementById('taxInsights');
                
                // Fetch AI insights
                fetch('/api/tax-insights', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        form_id: {{ form.id }},
                        form_type: '{{ form_template.form_id }}',
                        tax_year: {{ form.tax_year }}
                    })
                })
                .then(response => response.json())
                .then(data => {
                    let insightsHTML = '<div class="mb-3">';
                    
                    if (data.insights && data.insights.length > 0) {
                        data.insights.forEach(insight => {
                            insightsHTML += `
                                <div class="card border-0 shadow-sm mb-3">
                                    <div class="card-body p-3">
                                        <h6 class="card-title">${insight.title}</h6>
                                        <p class="card-text small">${insight.description}</p>
                                        ${insight.saving ? `<div class="text-success fw-bold">Potential Saving: ${insight.saving}</div>` : ''}
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        insightsHTML += `
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                No additional insights available for this form.
                            </div>
                        `;
                    }
                    
                    insightsHTML += '</div>';
                    
                    // Add refresh button
                    insightsHTML += `
                        <button class="btn btn-sm btn-outline-secondary w-100" id="refreshInsightsBtn">
                            <i class="fas fa-sync-alt me-2"></i> Refresh Insights
                        </button>
                    `;
                    
                    insightsContainer.innerHTML = insightsHTML;
                    
                    // Add event listener to refresh button
                    document.getElementById('refreshInsightsBtn').addEventListener('click', function() {
                        loadInsightsBtn.disabled = false;
                        loadInsightsBtn.innerHTML = '<i class="fas fa-brain me-2"></i> Generate Insights';
                        insightsContainer.innerHTML = `
                            <div class="placeholder-glow mb-3">
                                <span class="placeholder col-12"></span>
                                <span class="placeholder col-10"></span>
                                <span class="placeholder col-8"></span>
                            </div>
                            
                            <button class="btn btn-sm btn-outline-primary w-100" id="loadInsightsBtn">
                                <i class="fas fa-brain me-2"></i> Generate Insights
                            </button>
                        `;
                        document.getElementById('loadInsightsBtn').addEventListener('click', loadInsightsBtn.onclick);
                    });
                })
                .catch(error => {
                    console.error('Error fetching insights:', error);
                    insightsContainer.innerHTML = `
                        <div class="alert alert-danger mb-3">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Unable to generate insights at this time. Please try again later.
                        </div>
                        
                        <button class="btn btn-sm btn-outline-primary w-100" id="retryInsightsBtn">
                            <i class="fas fa-redo me-2"></i> Try Again
                        </button>
                    `;
                    
                    document.getElementById('retryInsightsBtn').addEventListener('click', function() {
                        loadInsightsBtn.disabled = false;
                        loadInsightsBtn.innerHTML = '<i class="fas fa-brain me-2"></i> Generate Insights';
                        insightsContainer.innerHTML = `
                            <div class="placeholder-glow mb-3">
                                <span class="placeholder col-12"></span>
                                <span class="placeholder col-10"></span>
                                <span class="placeholder col-8"></span>
                            </div>
                            
                            <button class="btn btn-sm btn-outline-primary w-100" id="loadInsightsBtn">
                                <i class="fas fa-brain me-2"></i> Generate Insights
                            </button>
                        `;
                        document.getElementById('loadInsightsBtn').addEventListener('click', loadInsightsBtn.onclick);
                    });
                });
            });
        }
    });
</script>
{% endblock %}